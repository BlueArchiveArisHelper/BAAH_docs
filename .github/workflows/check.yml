name: Check PR

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Block PR merge
        run: |
          gh pr review ${{ github.event.pull_request.number }} \
            --body "æ£€æŸ¥å¼€å§‹ï¼Œè¯·ç­‰å¾…ã€‚æ­¤PRæš‚æ—¶æ— æ³•åˆå¹¶ã€‚" \
            --request-changes

      - name: Create check comment
        id: create_comment
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## æ£€æŸ¥è¿›åº¦\n\nâ³ å¼€å§‹æ£€æŸ¥..."

      - name: Check deadlink
        run: |
          python3 TOOLS/deadlink_checker.py
          gh pr comment ${{ github.event.pull_request.number }} \
            --edit-last \
            --body "## æ£€æŸ¥è¿›åº¦\n\nâœ… æ­»é“¾æ£€æŸ¥å®Œæˆ\nâ³ æ­£åœ¨æ£€æŸ¥å›¾ç‰‡..."

      - name: Check image
        run: |
          python3 TOOLS/webp_checker.py
          gh pr comment ${{ github.event.pull_request.number }} \
            --edit-last \
            --body "## æ£€æŸ¥è¿›åº¦\n\nâœ… æ­»é“¾æ£€æŸ¥å®Œæˆ\nâœ… å›¾ç‰‡æ£€æŸ¥å®Œæˆ\nâ³ æ£€æŸ¥å®Œæˆ..."
      
      - name: Allow PR merge
        if: always()
        run: |
          if [ -f "error.txt" ]; then
            ERROR_CONTENT=$(cat error.txt)
            gh pr review ${{ github.event.pull_request.number }} \
              --body "âŒ æ£€æŸ¥æœªé€šè¿‡ï¼ŒPRæ— æ³•åˆå¹¶ã€‚\n\né”™è¯¯ä¿¡æ¯ï¼š\n\`\`\`\n$ERROR_CONTENT\n\`\`\`" \
              --request-changes
            if [ -f "warn.txt" ]; then
              WARN_CONTENT=$(cat warn.txt)
              gh pr comment ${{ github.event.pull_request.number }} \
                --edit-last \
                --body "## æ£€æŸ¥è¿›åº¦\n\nâŒ æ£€æŸ¥æœªé€šè¿‡\n\nâš ï¸ è­¦å‘Šä¿¡æ¯ï¼š\n\`\`\`\n$WARN_CONTENT\n\`\`\`\n\nâŒ é”™è¯¯ä¿¡æ¯ï¼š\n\`\`\`\n$ERROR_CONTENT\n\`\`\`"
            else
              gh pr comment ${{ github.event.pull_request.number }} \
                --edit-last \
                --body "## æ£€æŸ¥è¿›åº¦\n\nâŒ æ£€æŸ¥æœªé€šè¿‡\n\nâŒ é”™è¯¯ä¿¡æ¯ï¼š\n\`\`\`\n$ERROR_CONTENT\n\`\`\`"
            fi
          elif [ -f "warn.txt" ]; then
            WARN_CONTENT=$(cat warn.txt)
            gh pr review ${{ github.event.pull_request.number }} \
              --body "âš ï¸ æ£€æŸ¥é€šè¿‡ä½†æœ‰è­¦å‘Šï¼ŒPRå¯ä»¥åˆå¹¶ã€‚\n\nè­¦å‘Šä¿¡æ¯ï¼š\n\`\`\`\n$WARN_CONTENT\n\`\`\`" \
              --approve
            gh pr comment ${{ github.event.pull_request.number }} \
              --edit-last \
              --body "## æ£€æŸ¥è¿›åº¦\n\nâœ… æ£€æŸ¥å®Œæˆ\n\nâš ï¸ è­¦å‘Šä¿¡æ¯ï¼š\n\`\`\`\n$WARN_CONTENT\n\`\`\`\n\nğŸ‰ PRå¯ä»¥åˆå¹¶"
          else
            gh pr review ${{ github.event.pull_request.number }} \
              --body "æ£€æŸ¥å®Œæˆï¼ŒPRå¯ä»¥åˆå¹¶ã€‚" \
              --approve
            gh pr comment ${{ github.event.pull_request.number }} \
              --edit-last \
              --body "## æ£€æŸ¥è¿›åº¦\n\nâœ… æ‰€æœ‰æ£€æŸ¥å®Œæˆ\nğŸ‰ PRå¯ä»¥åˆå¹¶"
          fi


